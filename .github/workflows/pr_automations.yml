# Runs all automations related to PR events
name: PR automations

on:
  workflow_run:
    workflows:
      - PR automations init
    types:
      - completed

jobs:
  run:
    name: Perform PR automations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup CI env
        uses: ./.github/actions/setup-env
        with:
          setup_python: false
          install_recipe: node-install

      # This step was copied from the GitHub docs.
      # Ref: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#using-data-from-the-triggering-workflow
      - name: Download artifact
        uses: actions/github-script@v6
        with:
          script: |
            let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: context.payload.workflow_run.id,
            });
            let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
              return artifact.name == "event_info"
            })[0];
            let download = await github.rest.actions.downloadArtifact({
               owner: context.repo.owner,
               repo: context.repo.repo,
               artifact_id: matchArtifact.id,
               archive_format: 'zip',
            });
            let fs = require('fs');
            fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/event_info.zip`, Buffer.from(download.data));

      - name: Perform PR automations
        run: |
          unzip event_info.zip
          source event_info.env
          pnpm prs --event_name "$EVENT_NAME" --event_action "$EVENT_ACTION"
          rm event_info.env
          rm event.json
        env:
          EVENT_PAYLOAD: ${{ toJson(github.event) }}
        working-directory: automations/js
