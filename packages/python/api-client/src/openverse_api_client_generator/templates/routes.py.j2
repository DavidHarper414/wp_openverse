from typing import Protocol, Literal, Any, TypedDict, ReadOnly, overload
import typing
from abc import ABC

from openverse_api_client._utils import Empty, EMPTY, is_empty


class Route(ABC):
    path: str
    method: Literal["GET", "POST"]
    content_type: str
    json_response: bool

    path_params: None | dict[str, str]
    query_params: None | dict[str, Any]
    body: None | dict[str, Any]


{% for route in routes %}
class {{ route.py_route_methodname }}(Route):
    path = "{{ route.path }}"
    method = "{{ route.method | upper }}"
    content_type = "{{ route.content_type }}"
    json_response = {{ "True" if route.json_response else "False" }}

    def __init__(
        self,
        {%- for param in route.path_params.values() %}
        {{ param.py_parameter_string }},
        {%- endfor %}
        {% if route.has_params_or_body %}
        *,
        {% endif %}
        {%- for param in route.required_query_params %}
        {{ param.py_parameter_string }},
        {%- endfor %}
        {%- for param in route.required_body_params %}
        {{ param.py_parameter_string }},
        {%- endfor %}
        {%- for param in route.optional_query_params %}
        {{ param.py_parameter_string }},
        {%- endfor %}
        {%- for param in route.optional_body_params %}
        {{ param.py_parameter_string }},
        {%- endfor %}
    ):
        {%- if route.path_params %}
        self.path_params = {
            {%- for param in route.path_params.values() %}
            "{{ param.name }}": {{ param.name }},
            {%- endfor %}
        }
        {% else %}
        self.path_params = None
        {% endif %}

    {%- if route.query_params %}
        {%- if route.has_required_query_params %}
        self.query_params = {
            {%- for param in route.required_query_params %}
            "{{ param.name }}": {{ param.name }},
            {%- endfor %}
        }
        {%- else %}
        self.query_params = {}
        {%- endif %}

        {%- for param in route.optional_query_params %}
        if not is_empty({{ param.name }}):
            self.query_params["{{ param.name }}"] = {{ param.name }}
        {%- endfor %}

        {%- else %}
        self.query_params = None
    {%- endif %}

    {% if route.request_body %}
        {%- if route.has_required_body_params %}
        self.body = {
            {%- for param in route.required_body_params %}
            "{{ param.name }}": {{ param.name }},
            {%- endfor %}
        }
        {%- else %}
        self.body = {}
        {%- endif %}
        {%- for param in route.optional_body_params %}
        if not is_empty({{ param.name }}):
            self.body["{{ param.name }}"] = {{ param.name }}
        {%- endfor %}

        {% else %}
        self.body = None
    {%- endif %}


{% endfor %}


class _Endpoints:
    """Retrieve endpoints from a protected dict."""

    _ENDPOINTS = {
        {% for route in routes %}
        "{{ route.endpoint }}": {{ route.py_route_methodname }},
        {% endfor %}
    }

    {% for route in routes %}
    @overload
    def __getitem__(self, key: Literal["{{ route.endpoint }}"]) -> type[{{ route.py_route_methodname }}]:
        ...
    {% endfor %}

    def __getitem__(self, key: str):
        return self._ENDPOINTS[key]

ENDPOINTS = _Endpoints()
